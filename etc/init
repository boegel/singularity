# This will be sourced before launching a Singularity container.
# Any variables prefixed with "SINGULARITYENV_" will be transposed
# properly into the container. For example:
# SINGULARITYENV_LD_LIBRARY_PATH -> LD_LIBRARY_PATH

# Environment modules if set, cause errors in containers
unset module
unset ml

# Bash env has been known to cause issues in containers
unset BASH_ENV

# Provide a sane path within the container
if [ -z ${SINGULARITYENV_PATH+x} ]; then
    SINGULARITYENV_PATH="/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin"
else
    SINGULARITYENV_PATH="$SINGULARITYENV_PATH:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin"
fi

# Don't save the shell's HISTFILE
SINGULARITYENV_HISTFILE=""

export SINGULARITYENV_PATH SINGULARITYENV_HISTFILE

# UGent only allow images from user scratch directories
# and VSC singularity group users.
# $IMAGE_PATH will be empty if realpath is not able to find
# $SINGULARITY_IMAGE in the file system.
IMAGE_PATH="$(/usr/bin/realpath "$SINGULARITY_IMAGE" 2> /dev/null)"
SINGULARITY_VSC_GROUP="gsingularity"

if [ -z "$IMAGE_PATH" ]; then
    echo "ERROR: $SINGULARITY_IMAGE is not a valid image" >&2
    exit 1
fi

if [[ $IMAGE_PATH =~ /vscmnt/.+_apps/.+|.+/user/(home|data)/.+ ]]; then
    echo "ERROR: found not allowed path in $IMAGE_PATH" >&2
    exit 1
fi

# Detect user groups and allow $SINGULARITY_VSC_GROUP
if /usr/bin/id -nG | /usr/bin/grep -qw "$SINGULARITY_VSC_GROUP"; then
    echo "$USER belongs to $SINGULARITY_VSC_GROUP"
else
    echo "ERROR: $USER does not belong to $SINGULARITY_VSC_GROUP" >&2
    exit 2
fi

# Log user Singularity command for ELK
/usr/bin/logger -t singularity "user=$USER image=$IMAGE_PATH jobid=${PBS_JOBID:-} cmd=$SINGULARITY_COMMAND"
